#Замечание

Здесь не написан нормальный алгоритм нахождения локальной гистограммы, потому что сам по себе метод малорезультативен: есть жесткие края. Если же использовать сглаживающую фнкцию, то асимтотически будет такая же, как сейчас, сложность. И это будет неприемлимо по времени. Возможно есть алгоритмы быстрого вычисления ядер, но необходимо хоть какое-то время для их изучения.
